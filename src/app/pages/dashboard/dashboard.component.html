<div class="dashboard-container"
     [class.sidebar-collapsed]="sidebarCollapsed"
     [class.ai-sidebar-collapsed]="aiChatSidebarCollapsed"
     [class.loaded]="dashboardLoaded">
  <!-- Issues Sidebar (Left) -->
  <app-issues-sidebar
    [issuesRequiringAttention]="issuesRequiringAttention"
    (collapsedChange)="onSidebarCollapsedChange($event)">
  </app-issues-sidebar>

  <!-- AI Chat Sidebar (Right) -->
  <app-ai-chat-sidebar
    (collapsedChange)="onAiChatSidebarCollapsedChange($event)">
  </app-ai-chat-sidebar>



  <!-- Loading State -->
  @if (loading) {
    <div class="loading-container">
      <app-loading-spinner 
        message="Loading your issues..."
        size="large">
      </app-loading-spinner>
    </div>
  }

  <!-- Kanban Board -->
  <section class="kanban-section" *ngIf="!loading">
    <!-- Filter Bar -->
    <app-issue-filter-bar
      [(searchQuery)]="searchQuery"
      [(selectedPriority)]="selectedPriority"
      [(selectedTypes)]="selectedTypes"
      [(selectedProjects)]="selectedProjects"
      [(selectedLabels)]="selectedLabels"
      [availablePriorities]="availablePriorities"
      [availableTypes]="availableTypes"
      [availableLabels]="availableLabels"
      [projects]="projects"
      (searchQueryChange)="onSearchChange()"
      (searchClear)="clearSearch()"
      (selectedPriorityChange)="onFilterChange()"
      (selectedTypesChange)="onFilterChange()"
      (selectedProjectsChange)="onProjectsChange($event)"
      (selectedLabelsChange)="onFilterChange()"
      (refresh)="refreshIssues()">
    </app-issue-filter-bar>

    <!-- Divider -->
    <div class="filters-board-divider"></div>

    <!-- Kanban Board -->
    <div class="kanban-board" cdkDropListGroup>
      <div
        *ngFor="let column of kanbanColumns"
        class="kanban-column"
        [attr.data-column-id]="column.id"
        cdkDropList
        [cdkDropListData]="column.issues"
        (cdkDropListDropped)="onDrop($event)">
        
        <!-- Column Header -->
        <div class="column-header">
          <h3 class="column-title">{{ column.title }}</h3>
          <span class="column-count">{{ column.issues.length }}</span>
        </div>

        <!-- Issue Cards -->
        <div class="column-content">
          <div
            *ngFor="let issue of column.issues"
            cdkDrag>
            
            <!-- Drag Placeholder -->
            <div class="kanban-card-placeholder" *cdkDragPlaceholder></div>

            <!-- Card Content -->
            <app-issue-card
              [issue]="issue"
              [showEpic]="true"
              (issueClick)="openIssueDetail($event.issue, $event.event)">
            </app-issue-card>
          </div>

          <!-- Empty Column State -->
          <div *ngIf="column.issues.length === 0" class="empty-column">
            <mat-icon class="empty-icon">inbox</mat-icon>
            <p>No issues</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Issue Groups - Nested (Epic View) - HIDDEN FOR NOW -->
  <section class="issues-section" *ngIf="false && !loading && groupBy === 'epic'">

    <div *ngFor="let epicName of getObjectKeys(nestedIssues)" class="epic-group">
      <div class="epic-header">
        <h2 class="epic-title">{{ epicName }}</h2>
        <span class="epic-count">{{ getEpicTotalCount(epicName) }} issues</span>
      </div>

      <!-- Issue Types within Epic -->
      <div *ngFor="let issueType of getObjectKeys(nestedIssues[epicName])" class="type-group">
        <div class="type-header">
          <h3 class="type-title">{{ issueType }}s</h3>
          <span class="type-count">{{ nestedIssues[epicName][issueType].length }}</span>
        </div>

        <div class="issues-grid">
          <app-issue-card
            *ngFor="let issue of nestedIssues[epicName][issueType]"
            [issue]="issue"
            [showEpic]="false"
            (issueClick)="openIssueDetail($event.issue, $event.event)">
          </app-issue-card>
        </div>
      </div>
    </div>
  </section>

  <!-- Issue Groups - Regular (Status/Project/Priority View) -->
  <section class="issues-section" *ngIf="!loading && groupBy !== 'epic'">
    <div *ngFor="let group of getObjectKeys(issuesByStatus)" class="issue-group">
      <div class="group-header">
        <h2>{{ group }}</h2>
        <span class="group-count">{{ issuesByStatus[group].length }}</span>
      </div>

      <div class="issues-grid">
        <app-issue-card
          *ngFor="let issue of issuesByStatus[group]"
          [issue]="issue"
          [showEpic]="true"
          (issueClick)="openIssueDetail($event.issue, $event.event)">
        </app-issue-card>
      </div>
    </div>

    <!-- Empty State -->
    <div *ngIf="allIssues.length === 0" class="empty-state">
      <div class="empty-icon">ðŸ“­</div>
      <h2>No issues found</h2>
      <p>You don't have any issues assigned to you.</p>
    </div>
  </section>

  <!-- Issue Detail Modal -->
  <app-issue-detail-modal
    [issue]="selectedIssue"
    [showModal]="showDetailModal"
    [cardPosition]="cardPosition"
    (close)="closeIssueDetail()">
  </app-issue-detail-modal>
</div>
